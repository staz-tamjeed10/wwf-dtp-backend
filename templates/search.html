{% extends 'base.html' %}

{% block title %}Leather Tracking | Trace Here{% endblock %}

{% block content %}
<style>
    :root {
        --primary-bg: #192752;
        --secondary-bg: #F8CE9F;
        --accent-color: #723B18;
        --error-color: #ff6b6b;
        --transition-time: 0.3s;
        --input-text: #2D1A0F;
        --text-light: #F8CE9F;
    }

    .tracking-container {
        background-color: var(--secondary-bg);
        min-height: 100vh;
        padding: 2rem 1rem;
        display: grid;
        place-items: center;
    }

    .auth-card {
        background-color: var(--primary-bg);
        color: var(--text-light);
        border-radius: 1.5rem;
        max-width: 600px;
        width: 95%;
        margin: 0 auto;
        box-shadow: 0 10px 30px rgba(25, 39, 82, 0.2);
        animation: formEntrance 0.6s ease-out;
    }

    .form-control {
        background-color: rgba(248, 206, 159, 0.15);
        border: 2px solid var(--secondary-bg);
        color: var(--input-text);
        transition: all var(--transition-time) ease;
        min-height: 45px;
    }

    .form-control:focus {
        background-color: rgba(248, 206, 159, 0.25);
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.25rem rgba(114, 59, 24, 0.25);
        color: var(--secondary-bg);
        transform: translateY(-2px);
    }

    .input-group-text {
        background-color: var(--secondary-bg);
        border: 2px solid var(--secondary-bg);
        color: var(--primary-bg);
    }

    .btn-primary {
        background-color: var(--secondary-bg);
        color: var(--accent-color);
        font-weight: 600;
        transition: all var(--transition-time) ease;
        border: none;
    }

    .btn-primary:hover {
        background-color: #f5b97a;
        transform: translateY(-3px);
    }

    .invalid-feedback {
        color: var(--error-color);
        animation: slideIn 0.3s ease-out;
    }

    .qr-scanner {
        border: 2px dashed var(--secondary-bg);
        background: rgba(248, 206, 159, 0.1);
        transition: all 0.3s ease;
    }

    @keyframes formEntrance {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
        .auth-card {
            border-radius: 1rem;
        }
        
        .form-control {
            font-size: 16px;
            min-height: 50px;
        }
    }
</style>

<div class="tracking-container">
    <div class="auth-card">
        <div class="card-body p-3 p-md-5">
            <div class="text-center mb-5">
                <h2 class="fw-bold" style="color: var(--secondary-bg);">
                    <i class="fas fa-search-location me-2"></i> Trace Here
                </h2>
                <p class="auth-subtitle" style="color: var(--text-light); opacity: 0.9;">
                    Trace a Product
                </p>
            </div>
            
            {% if error_message %}
            <div class="alert alert-danger text-center fw-bold" role="alert">
                ❌ {{ error_message }}
            </div>
            {% endif %}
            {% if success_message %}
            <div class="alert alert-success text-center fw-bold" role="alert">
                ✅ {{ success_message }}
            </div>
            {% endif %}
            
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="mb-4">
                    <label class="form-label text-light">Product ID</label>
                    <div class="input-group">
                        <span class="input-group-text rounded-start-4">
                            <i class="fas fa-id-badge"></i>
                        </span>
                        <input type="text" 
                               class="form-control shadow-sm rounded-end-4" 
                               name="search_id"
                               placeholder="Enter Product ID (e.g., LT12345)"
                               required>
                        <div class="invalid-feedback">
                            Please enter a valid Product ID
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100 rounded-pill py-2">
                    <i class="fas fa-search me-2"></i> Search
                </button> 
            </form>
                        

            <form method="post" class="mt-4">
                {% csrf_token %}
                <button type="submit" 
                        name="start_scanning" 
                        class="btn btn-primary w-100 rounded-pill py-2">
                    <i class="fas fa-qrcode me-2"></i>Start QR Scan
                </button>
            </form>

            {% if scanning %}
            <div class="mt-5 text-center">
                <h4 class="fw-bold mb-4" style="color: var(--secondary-bg);">
                    <i class="fas fa-camera me-2"></i>QR Scanner
                </h4>
                <div id="outdiv" class="qr-scanner rounded-3 p-2 mx-auto" style="max-width: 480px;">
                    <video id="video" class="w-100 rounded-2" autoplay muted playsinline></video>
                </div>
                <canvas id="qr-canvas" style="display: none;"></canvas>
                <div id="qr-message" class="mt-3" style="color: var(--secondary-bg);">
                    <i class="fas fa-info-circle me-2"></i>Align QR code within frame
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- QR Scanner Script -->
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<script>
    document.querySelectorAll('.form-control').forEach(input => {
        input.addEventListener('focus', () => {
            input.parentElement.style.transform = 'translateY(-2px)';
        });
        input.addEventListener('blur', () => {
            input.parentElement.style.transform = 'translateY(0)';
        });
    });

    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(() => {
            alert.style.opacity = '0';
            setTimeout(() => alert.remove(), 300);
        }, 5000);
    });

    {% if scanning %}
    const video = document.getElementById('video');
    const canvas = document.getElementById('qr-canvas');
    const context = canvas.getContext('2d');
    const messageElement = document.getElementById('qr-message');

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then((stream) => {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(scanQR);
    })
    .catch((err) => {
        console.error("Camera error:", err);
        messageElement.innerHTML = `<i class="fas fa-video-slash me-2"></i>Camera access required`;
    });

    function scanQR() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            
            if (code) {
                messageElement.innerHTML = `<i class="fas fa-check-circle me-2"></i>Scan successful!`;
                setTimeout(() => {
                    window.location.href = code.data;
                }, 1000);
                return;
            }
        }
        requestAnimationFrame(scanQR);
    }
    {% endif %}
</script>
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}